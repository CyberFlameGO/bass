#!/usr/bin/env bass

(def *memos* *dir*/bass.lock)

(use (.git (linux/nixery.dev/git)))

(defn build-nixery [uri ref]
  (subpath
    (from (linux/nixery.dev/go)
      (cd (git:checkout uri (git:ls-remote uri ref))
        ($ go build -o ./nixery ./cmd/server)))
    ./nixery))

(defn main [uri ref]
  (emit
    (from (linux/nixery.dev/shell)
      ($ cp (build-nixery uri ref) /usr/bin/nixery)
      ($ mkdir -p /var/lib/nixery/ /srv/www/))
    *stdout*))
