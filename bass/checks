#!/usr/bin/env bass

(use (.git (linux/alpine/git))
     (*dir*/github))

; a github client that uses commit statuses for checks
(defn status-client [repo]
  (module [start-check]
    (def auth
      {:token (mask *env*:GITHUB_TOKEN :github-token)})

    (defn start-check [thunk name sha]
      (github:start-status thunk name sha repo auth))))

; runs the configured checks
;
; Runs all checks in parallel, updates the GitHub commit status for each
; and waits for them all to complete.
(defn main []
  (for [{(:repo "vito/bass") repo
         (:clone-url "https://github.com/vito/bass") clone-url
         :sha sha} *stdin*]
    (let [github (status-client repo)
          src (git:checkout clone-url sha)
          project (load (*dir*/../project))]
      (map (fn [wait] (log "check completed" :result (wait)))
           (project:start-checks src sha github)))))
