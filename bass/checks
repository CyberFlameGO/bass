#!/usr/bin/env bass

(use (.git (linux/alpine/git))
     (*dir*/github))

; a github client that uses commit statuses for checks
(def status-client
  (module [check]
    (def auth
      {:token (mask *env*:GITHUB_TOKEN :github-token)})

    (defn check [thunk name sha repo]
      (github:start-status thunk name sha repo auth))))

; runs the configured checks
;
; Runs all checks in parallel, updates the GitHub commit status for each
; and waits for them all to complete.
(defn main []
  (for [{(:repo "vito/bass") repo
         :sha sha} *stdin*]
    (let [clone-url (str "https://github.com/" repo)
          src (git:checkout clone-url sha)
          project (load (*dir*/../project))]
      (map (fn [wait] (log "check completed" :result (wait)))
           (project:start-checks src sha repo status-client)))))
