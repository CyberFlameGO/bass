#!/usr/bin/env bass

(def *memos* *dir*/bass.lock)

(use (*dir*/nixery))

(def nixery-cache
  (cache-dir "nixery"))

(defn main []
  (-> ($ nixery)
      (with-image (linux/basslang/nixery))
      (with-mount nixery-cache /var/lib/nixery/)
      (with-env {:NIXERY_STORAGE_BACKEND "filesystem"
                 :STORAGE_PATH "/var/lib/nixery"
                 :PORT "9110"
                 :WEB_DIR "/srv/www"
                 :NIXERY_CHANNEL "nixos-unstable"})
      (with-ports {:registry 9110})
      serve))
